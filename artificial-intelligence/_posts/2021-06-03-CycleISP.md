---
layout: post
title: ã€Denoisingã€‘ CycleISP- Real Image Restoration via Improved Data Synthesis
---

- **Paper**: [CycleISP: Real Image Restoration via Improved Data Synthesis](https://arxiv.org/abs/2003.07761)
- **Type**: Denoising 



# í•µì‹¬ ìš”ì•½

<img src="/Users/junha/Library/Application Support/typora-user-images/image-20210603100449645.png" alt="image-20210603100449645" style="zoom:80%;" />

- RGBì— noiseë¥¼ ë„£ëŠ”ê²Œ ì•„ë‹ˆë¼, RAWì— noiseë¥¼ ë„£ì–´ì„œ, noise RGBë¥¼ ìƒì„±í•œë‹¤.
- RGB -> RAWë¡œ ë§Œë“¤ê¸° ìœ„í•´ì„œ, ì¹´ë©”ë¼ íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë³µì›í•œë‹¤. (generalizabilityí™•ë³´ ê°€ëŠ¥, reverse engineering í•„ìš” ì—†ìŒ)
- `Real camera noise` ë¥¼ ëª¨ë‘ ê³ ë ¤í•˜ì—¬, Denoisingì„ í•˜ë ¤ë©´ RGBì—ì„œ denoiseí•˜ëŠ” ê²ƒ ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•˜ë‹¤. RAW, RGB ëª¨ë‘ì—ì„œ Denoisingí•˜ëŠ” ëª¨ë¸ì„ ê°œë°œí•œë‹¤.
- ìœ„ CycleISP ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©í•´ì„œ ë§Œë“¤ê³  ì‹¶ì€ ë°ì´í„°ì…‹ì´ ì´ê±°ë‹¤. (1) `{RAW_clean, RAW_noisy}` (2) `{sRGBclean, sRGBnoisy}`. ì´ê²ƒì„ ì‚¬ìš©í•´ì„œ ëª¨ë¸ì„ í•™ìŠµì‹œí‚¨ë‹¤!







---

---

# CycleISP

# 1. Conclusion, Instruction, Conclusion

- Task: single-image denoising problem (+ color matching problem in stereoscopic cinema)

- **Dataset ë¶€ì¡± ë¬¸ì œ**

  1. Object Detection, Segmentationì€ large annotated datasets ë•ë¶„ì— ì¢‹ì€ ì„±ëŠ¥ì„ ì–»ì—ˆë‹¤. 
  2. low-level vision problems (image denoising, super-resolution, deblurring, etc.) ì—ì„œëŠ” ë°ì´í„° ì…‹ì´ ì—†ë‹¤. 
  3. **[Noise -> clean Image]**ë¥¼ ìœ„í•´ì„œ pixel-wise averagingë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì´ëŠ” ì¢‹ì§€ ì•Šë‹¤. 
  4. ì™œëƒí•˜ë©´ lighting condition change ì™€ scamera/object motionì— ì˜í•´ì„œ spatial pixels misalignment, color and brightness mismatch ê°€ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì´ë‹¤.
  5. **[Clean -> Noise Image]** AWGN(additive white Gaussian noise)ë¥¼ ì‚¬ìš©í•´ì„œ ë°ì´í„° ì…‹ì„ ìƒì„±í–ˆë‹¤. ì´ë ‡ê²Œ ìƒì„±ëœ ëª¨ë¸ì— CNN ëª¨ë¸ì´ ì˜ ë™ì‘í•˜ì§€ë§Œ, Real camera imagesì—ì„œëŠ” ì˜ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤. 
  6. ì™œëƒí•˜ë©´, `real camera noise`ëŠ” AWGN ë¿ë§Œ ì•„ë‹ˆë¼ **(1)**. Signal-dependent (RAW -> demosaicking -> spatio-chromatically correlated -> ISP pipeline, the shot noise) ì™€ **(2)**. camera imaging pipeline (RAWì—ì„œ RGBë¥¼ ë§Œë“œëŠ” ISP ê³¼ì • ì¤‘ ì¼ë¶€) **(3)** signal-independent additive Gaussian component(AWGN, the read noise) ì—ì„œ ë°œìƒí•˜ê¸° ë•Œë¬¸ì´ë‹¤. 
  7. ê²Œë‹¤ê°€ ì¹´ë©”ë¼ ì¢…ë¥˜ë§ˆë‹¤ noiseì˜ ì„±ê²©ì´ ë‹¬ë¼ì„œ ë‹¤ì–‘í•œ ì¹´ë©”ë¼ë¡œ ì°ì€ ì‚¬ì§„ìœ¼ë¡œ ë°ì´í„°ì…‹ì„ ë§Œë“¤ì–´ì•¼ í•œë‹¤. 

- **ì´ ë…¼ë¬¸ì˜ íŠ¹ì •** 

  1. ì´ ë…¼ë¬¸ì—ì„œëŠ” CycleISP ëª¨ë¸ì„ ì‚¬ìš©í•´ì„œ, Denoisingì„ ìœ„í•œ realistic image pairs(ë°ì´í„°ì…‹)ì„ ì§ì ‘ ë§Œë“¤ì–´ ë‚¸ë‹¤. SOTA ë‹¬ì„± ë° ë‹¤ë¥¸ ëª¨ë¸ë³´ë‹¤ 5ë°° ì ì€ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±ì„ ê°€ì§„ë‹¤.

  2. The main idea: (ë°ì´í„° ìƒì„± ìœ„í•´) RGBì— noiseë¥¼ ë„£ëŠ”ê²Œ ì•„ë‹ˆë¼, RAWì— noiseë¥¼ ë„£ì–´ì„œ, noise RGBë¥¼ ìƒì„±í•œë‹¤. 

     - RGB ì—ì„œ denoiseë¥¼ ìˆ˜í–‰í•˜ëŠ” ê²ƒì€, ìœ„ì˜ real camera noise 3ê°€ì§€ ìš”ì†Œë¥¼ ê³ ë ¤í•˜ì§€ ì•Šì€ ê²ƒì´ë‹¤. 
     - (Denoising ëª¨ë¸ ê°œë°œì„ ìœ„í•´ì„œ) ë”°ë¼ì„œ RGB ë¿ë§Œ ì•„ë‹ˆë¼ RAW ê¹Œì§€ì—ì„œë„ denoiseí•˜ëŠ” CNN ëª¨ë“ˆì„ ê°œë°œí•˜ê³  ì‚¬ìš©í–ˆë‹¤.

  3. The main challenge: ìˆ˜ë§ì€ RGB ë°ì´í„°ë¥¼ RAWë¡œ ì–´ë–»ê²Œ ë³µì›í•  ê²ƒì¸ê°€?

     - [7, CVPR2017] ì—ì„œ Camera/ISPì˜ íŒŒë¼ë¯¸í„°(black box, (e.g, color correction matrices and white balance gains))ë¥¼ ì´ìš©í•´ì„œ ë³µì›í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í–ˆë‹¤. ì´ ë°©ë²•ì€ í•œ ë””ë°”ì´ìŠ¤(ì¹´ë©”ë¼)ë§Œì˜ ì •ë³´ë¥¼ ì´ìš©í•˜ê¸°ì— generalizabilityê°€ ë–¨ì–´ì§€ê³ , ì‚¬ì‹¤ìƒ ISPì˜ black boxë¥¼ reverse engineeringí•˜ê¸°ëŠ” ê±°ì˜ ë¶ˆê°€ëŠ¥ì´ë‹¤. 
     - ë”°ë¼ì„œ ìš°ë¦¬ëŠ” ì´ëŸ° íŒŒë¼ë¯¸í„°ì  ì§€ì‹ì„ í•„ìš”ë¡œ í•˜ì§€ ì•ŠëŠ” ëª¨ë¸ì„ ë§Œë“ ë‹¤.

     



---

# 2. Relative work

- Denoising conventional methods
  1. Denoising ê¸°ë²•ì€ í¬ê²Œ 2ê°€ì§€ ì˜€ë‹¤. 
     - (1) transform coefficients(íŠ¹ì • ê³„ìˆ˜ ë°”ê¾¸ê¸°): DCT [61],  wavelets [19, 54] ë¥¼ ì‚¬ìš©í•´ì„œ.
     - (2) Averaging neighborhood values:  similar values [55, 57], along contours [42, 50]ë¥¼ ê³ ë ¤í•´ì„œ.
  2. [8] A non-local algorithm for image denoising(**NLM**, Non-local Means). CVPR, 2005 ì—ì„œ íšê¸°ì ì¸ ë°œì „. ì´ê²ƒì„ ê¸°ë°˜í•œ ëª¨ë¸ë“¤ì´ ë‚˜ì™”ì„ ë¿
- Benchmark Dataset [1, 44] - CVPR2017
- AWGNì„ ì‚¬ìš©í•œ conventional model [8, 15, 22, 24]
  - AWGNì„ ì‚¬ìš©í•œ ì•Œê³ ë¦¬ì¦˜, ëª¨ë¸ë“¤ì€ ì‹¤ì œ ì´ë¯¸ì§€ì—ì„œ denoiseë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ í•˜ì§€ ëª»í•œë‹¤.
- SOTA Denoising Deep learning ëª¨ë¸  [**4**, **7**, 25, 28, **45**, 64, 65, 2] 
  1. [4] Real image denoising with feature attention. ICCV, 2019
  2. [7] Unprocessing images for learned raw denoising. CVPR, 2019: Camera/ISP(black box) ì •ë³´ ì´ìš©
  3. [45] Neural nearest neighbors networks. NeurIPS, 2018







---

# 3. CycleISP

![image-20210603165102906](/Users/junha/Library/Application Support/typora-user-images/image-20210603165102906.png)

- Network1. RGB2RAW // Network2. RAW2RGB // **ê°ê° ë¨¼ì € í•™ìŠµì‹œí‚¤ê³ (3.1, 3.2) ë‚˜ì¤‘ì— ê°™ì´ í•™ìŠµì‹œí‚¨ë‹¤.** 
- ìš©ì–´ í˜¼ë™ì„ ìœ„í•´ì„œ sRGBëŒ€ì‹ ì— RGBë¥¼ ì‚¬ìš©í•œë‹¤. 
- ì¶”ê°€) sRGBë€ ë¬´ì–¸ì¸ê°€.
  - [ì°¸ê³  ì‚¬ì´íŠ¸1](https://stackoverflow.com/questions/50622180/does-pil-image-convertrgb-convert-images-to-srgb-or-adobergb), [ì°¸ê³  ì‚¬ì´íŠ¸2](https://stackoverflow.com/questions/35952564/convert-rgb-to-srgb), [ì°¸ê³  ì‚¬ì´íŠ¸3](https://www.cambridgeincolour.com/tutorials/gamma-correction.htm) 
  - sRGB and Adobe RGB are just *RGB color spaces*. í”„ë¦°í„°, ëª¨ë‹ˆí„°ê°€ ì–´ë–»ê²Œ renderingí•  ê²ƒì¸ì§€ì— ëŒ€í•œ ê·œì¹™ì´ë‹¤. JPEG íŒŒì¼ í˜•ì‹ ë‚´ë¶€ì— ì í˜€ ìˆë‹¤. 
  - ì´ë¯¸ì§€ ê°ë§ˆë³´ì •ì— ëŒ€í•´ì„œ, ì¶”ê°€ ê³µë¶€í•˜ê¸°. ([ì°¸ê³ ì‚¬ì´íŠ¸ 4](https://smartits.tistory.com/130), [ì°¸ê³  ì‚¬ì´íŠ¸5](https://smartits.tistory.com/130))





## 3.1. RGB2RAW Network Branch

- Figure2 ì—ì„œ, ìœ„ìª½ì˜ ë„¤íŠ¸ì›Œí¬. RGB, RAWê°€ ëª¨ë‘ ì œê³µë˜ëŠ” ë°ì´í„°ì…‹ì„ ì‚¬ìš©í•´ì„œ ëª¨ë¸ì„ í•™ìŠµì‹œí‚¨ë‹¤. 
- The main goal: Invert ISP effects(ì˜ˆë¥¼ ë“¤ì–´, tone mapping, gamma correction, color correction, white balance, and other transformations). ê·¸ë˜ì„œ ë§ì€ RGBë°ì´í„°ì—ì„œ RAWë¥¼ ìƒì„±í•˜ëŠ” ê²ƒ.
- Figureì˜ M1ì„ í†µê³¼í•´ì„œ 3-channelì„ ê°€ì§€ëŠ” featureì„ ë½‘ìŒìœ¼ë¡œì¨ ì›ë³¸ì´ë¯¸ì§€ì—ì„œ structural informationë¥¼ ìµœëŒ€í•œ ë§ì´ ìœ ì§€í•œë‹¤.
- Bayer sampling function(=Mosaic) ì„ ì‚¬ìš©í•´ì„œ RAW image (HxWx1)ì„ ìƒì„±í•œë‹¤. [ì½”ë“œ](https://github.com/swz30/CycleISP/blob/master/networks/cycleisp.py#L16)ì—ì„œëŠ” H/2 x W/2 x 4ì˜ RGGB imagesë¥¼ ë°”ë¡œ ë§Œë“ ë‹¤.
- LossëŠ” ì•„ë˜ì™€ ê°™ê³ , log domain lossë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ”, all the image valuesì— ë™ë“±í•˜ê²Œ lossë¥¼ treatmentí•˜ê¸° ìœ„í•´ì„œ ì´ë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ highlight regionsì—ë§Œ ì§‘ì¤‘í•˜ì—¬ Networkê°€ í•™ìŠµë  ê²ƒì´ë‹¤. (??= Image histogramì—ì„œ ë§ì€ ë¶€ë¶„ì„ ì°¨ì§€í•˜ëŠ” íŠ¹ì • valueì˜ í”½ì…€ê°’ë“¤ë§Œ í•™ìŠµì´ ì˜ ì¼ì–´ë‚˜ëŠ” ê²ƒì„ ë§‰ëŠ”ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ ì–´ë‘ìš´ ê°’ë“¤ì€ ë‹¤ ê³ ë§Œê³ ë§Œí•˜ë‹¤. Dynamic range ê°œë…?) ì•„ë˜ ì…ì‹¤ë¡ ì€ ì‘ì€ ìƒìˆ˜ê°’.

![image-20210603165559090](/Users/junha/Library/Application Support/typora-user-images/image-20210603165559090.png)





## 3.2. RAW2RGB Network Branch

- Figure2 ì—ì„œ, ì•„ë˜ìª½ì˜ ë„¤íŠ¸ì›Œí¬. RGB, RAWê°€ ëª¨ë‘ ì œê³µë˜ëŠ” ë°ì´í„°ì…‹ì„ ì‚¬ìš©í•´ì„œ ëª¨ë¸ì„ í•™ìŠµì‹œí‚¨ë‹¤. 
- ì´ ê³¼ì •ì—ì„œëŠ” clean RAW imagesì—ì„œ clean sRGB image ìƒì„±ì„ ëª©í‘œë¡œ í•œë‹¤. Noise injectionì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.
- Inputìœ¼ë¡œ ë“¤ì–´ê°€ëŠ” RAWëŠ” ìœ„ì˜ 3.1ì—ì„œ ë§Œë“¤ì–´ì§„ ë°ì´í„° ì‚¬ìš©í•˜ëŠ”ê±° ì•„ë‹ˆê³ , Supervision ìœ„í•œ ë°ì´í„°ì…‹ì„ ì‚¬ìš©í•œë‹¤.
- **3.2.(1) Color attention unit**
  - Figure2 ì—ì„œ ê°€ì¥ ì™¼ìª½ ëª¨ë“ˆ
  - ëª¨ë¸ì„ Warming upí•˜ê¸° ìœ„í•´ì„œ MIT-Adobe FiveK datasetì„ ì‚¬ìš©í•´ì„œ í•™ìŠµì‹œí‚¨ë‹¤. ì´ ë°ì´í„°ì…‹ì€ ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ ì¹´ë©”ë¼ë¡œ ìƒì„±ëœ ë°ì´í„°ì´ê¸° ë•Œë¬¸ì— ë‹¤ì–‘í•œ ISP parameterì— ì˜í•´ì„œ ë§Œë“¤ì–´ì§„ RGB ë°ì´í„° ì…‹ì´ë‹¤. ë”°ë¼ì„œ ê·¸ëƒ¥ í•™ìŠµì‹œí‚¤ë©´ í•™ìŠµì´ ì˜ ë˜ì§€ ì•ŠëŠ”ë‹¤.
  - Color attention(correlation) unitì„ ì‚¬ìš©í•´ì„œ í•™ìŠµì´ ì˜ ë˜ê²Œ ë§Œë“ ë‹¤. ë‹¤ì–‘í•œ ë””ë°”ì´ìŠ¤ì—ì„œ generalí•˜ê²Œ ë™ì‘í•˜ëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ ë§Œë“ ë‹¤. ì´ ëª¨ë“ˆì„ í†µí•´ì„œ RAW2RGBëª¨ë¸ì— explicit color attention ì„ ì œê³µí•  ìˆ˜ ìˆë‹¤. 
  - RGBì´ë¯¸ì§€ê°€ ë“¤ì–´ê°€ê¸°ì „ì— ê°•í•œ Gaussian blur(í‘œì¤€í¸ì°¨ 12)ë¥¼ ì ìš©í•¨ìœ¼ë¡œì¨, color ì •ë³´ë§Œì„ encodingí•œ attention featureë¥¼ ë§Œë“¤ë„ë¡ í•œë‹¤. blurë¥¼ ì ìš©í•´ì„œ structural content, fine textureë¥¼ ì œê±°í•œë‹¤.
- ì „ì²´ ê³¼ì • Lossì™€ ìˆ˜ì‹ì€ ì•„ë˜ì™€ ê°™ë‹¤. 

![image-20210603171237282](/Users/junha/Library/Application Support/typora-user-images/image-20210603171237282.png)







## 3.3. RRG: Recursive Residual Group

- less useful features ìœ„ì¹˜ëŠ” ë¬´ì‹œí•˜ê³ , useful featuresì— ì§‘ì¤‘í•˜ë„ë¡ ë§Œë“ ë‹¤.

<img src="/Users/junha/Library/Application Support/typora-user-images/image-20210603171404751.png" alt="image-20210603171404751" style="zoom:80%;" />







## 3.4. Joint Fine-tuning of CycleISP

- RGB2RAWì—ì„œ ë‚˜ì˜¨ RAW outputì´ RAW2RGBì˜ inputìœ¼ë¡œ ë“¤ì–´ê°„ë‹¤.

![image-20210603171502600](/Users/junha/Library/Application Support/typora-user-images/image-20210603171502600.png)







## 4. Synthetic Realistic Noise Data Generation

**ì§€ê¸ˆê¹Œì§€ í•™ìŠµì‹œí‚¨ CycleISP ëª¨ë¸ì„ ì‚¬ìš©í•´ì„œ ë°ì´í„° ìƒì„±í•˜ê¸°!**

- Data for RAW denoising
  - {RAW_clean, RAW_noisy} ìƒì„± 
  - The noise injection module ì„ ì´ì œ "ON" !
  - [ì½”ë“œ ë¶€ë¶„](https://github.com/swz30/CycleISP/blob/master/utils/noise_sampling.py) ì´ê³³ì˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ ë…¸ì´ì¦ˆë¥¼ ë„£ëŠ”ë‹¤. [7] ë…¼ë¬¸ì˜ sampling shot/read noise factorsë¥¼ ë„£ëŠ” ë°©ë²• ê·¸ëŒ€ë¡œ ì‚¬ìš©.
- Data for sRGB denoising
  - {sRGBclean, sRGBnoisy} ìƒì„±
  -  RAWnoisyë¥¼ ëª¨ë¸ì— ë„£ì–´ì„œ ë‚˜ì˜¤ëŠ” outputì„ RGBnoisyë¡œ ì‚¬ìš©í•œë‹¤. 
  - ì¶”ê°€ì ì€ ì‘ì—…ì„ ì—¬ê¸°ì„œ ë” í•œë‹¤. SIDDë°ì´í„° ì…‹ì„ ì´ìš©í•´ì„œ, (1) ì¶”ê°€ ë°ì´í„° ìƒì„± (2) CycleISP ëª¨ë“ˆ fine-tuning í•œë‹¤.    
    <img src="/Users/junha/Library/Application Support/typora-user-images/image-20210603172005653.png" alt="image-20210603172005653" style="zoom:100%;" />
  - 





## 5. Denoising Architecture

ìœ„ì—ì„œ ìƒì„±í•œ ë°ì´í„° ì…‹ì„ ì‚¬ìš©í•´ì„œ ìƒˆë¡œìš´ ë„¤íŠ¸ì›Œí¬ë¥¼ í•™ìŠµì‹œí‚¤ì! ì•„ë˜ì™€ ë˜‘ê°™ì€ ë„¤íŠ¸ì›Œí¬ë¥¼ 2ê°œ ë§Œë“¤ê³ , í•˜ë‚˜ëŠ” RAW denoising, ë‹¤ë¥¸ í•˜ë‚˜ëŠ” RGB denoisingì— ì‚¬ìš©í•œë‹¤. inputê³¼ output channelë§Œ ë‹¤ë¥´ê²Œ í•´ì£¼ë©´ ëœë‹¤. ê°ê° 3,4 ì‚¬ìš©.

![image-20210603172050114](/Users/junha/Library/Application Support/typora-user-images/image-20210603172050114.png)





---

# 6. Experiments

## 6.1. Real Image Datasets

1. DND [44]: 4ê°œ ì¹´ë©”ë¼ / high-resolution / í•œ ì¥ì˜ ì´ë¯¸ì§€ë¡œë¶€í„°, 20 crops of size 512 Ã— 512 / RAW and sRGB ë°ì´í„° ì œê³µ
2. SIDD [1]: ìŠ¤ë§ˆíŠ¸í°(small sensor size, high resolution = noise ì‹¬í•¨) / 5ê°œ ìŠ¤ë§ˆíŠ¸í° / 320+1280 ì´ë¯¸ì§€ pair  / RAW and sRGB ë°ì´í„° ì œê³µ
3. MIT-Adobe FiveK dataset [10]: Initial training ìœ¼ë¡œë§Œ ì‚¬ìš©. / 5000 RAW images / LibRaw library ì‚¬ìš©í•´ì„œ sRGB ì´ë¯¸ì§€ ìƒì„± 



## 6.2. Implementation Details

- Train: Adam optimizer / 128 Ã— 128 images / randomly horizontal and vertical flips
- Initial training of CycleISP: MIT-Adobe FiveK dataset [10] ë°ì´í„°ì…‹ ì‚¬ìš©. 



---

## 6.3,4 Results

1. **RAW denoising ê²°ê³¼.**   
   ![image-20210603175700345](/Users/junha/Library/Application Support/typora-user-images/image-20210603175700345.png)
2. **RGB denoising ê²°ê³¼.**   
   ![image-20210603180503524](/Users/junha/Library/Application Support/typora-user-images/image-20210603180503524.png)     
   ![image-20210603180735050](/Users/junha/Library/Application Support/typora-user-images/image-20210603180735050.png)     
   ![image-20210603180742320](/Users/junha/Library/Application Support/typora-user-images/image-20210603180742320.png)
3. 











---

---



