---
layout: post
title: 【Pytorch】Ubuntu re-install & mmclassification teardown reports 
---

Ubuntu re-install & mmclassification teardown reports 

# 1. New ubuntu setting List

1. 우분투 설치
2. gpu graphic driver 설치
3. docker, docker-nvidia 설치
4. Vscode 설치
5. anaconda 설치
6. docker image, container 필요한거 다운 및 설치 (MLworkspace, pytorch-cuda)
7. dataset 다운로드 (coco, imagenet)



# 2. Docker setting

- **Docker hub naming** ([참고 사이트](https://jybaek.tistory.com/791))

  - devel : 속편하지만 용량이 너무 큼
  - base : 가장 낮은 용량
  - runtime : 사용하기에 적절한 용량
  - 이유는 모르겠지만 `pytorch-1.5.1-cuda10.1-runtime`에서는 `cat /usr/local/cuda/version.txt`가 동작하지 않는다. 그럼에도 불구하고 예전에 detr을 cuda로 돌렸었다. mmclf에서는 cuda문제가 발생했으므로 속편하게 `pytorch-1.5.1-cuda10.1-devel` 사용해야겠다.

- **docker run --shm-size**

  - shared memory 사용 공간 ML-workspace에서 512MB를 주니, 대충 그정도 사용하면 될 듯하다.

- **docker run**    

  - detr에서 준 dockerfile을 build해서 사용했다. 하지만 cuda 문제가 발생했다. 
  - detr에서 준 docker image 부터가 잘못 됐다. 재설치 필요
  - [docker hub - pytorch 1.5.0 - devel](https://hub.docker.com/layers/pytorch/pytorch/1.5.1-cuda10.1-cudnn7-devel/images/sha256-dd934cd84b34cb341321e2fb68e9a7a2e1cfa635958370c3c0443c9304218176?context=explore) 을 사용한다. runtime에는 `cat /usr/local/cuda/version.txt` 가 동작하지 않는다. 맘편하게 devel사용한다.      
  - 아래와 같이 -v를 2번 가능하다. \<my path\>/\<container path\> 에서, \<container path\>는 path가 존재하지 않으면 자동으로 mkdir된다.

  ```sh
  $ sudo docker run -d -it      \
  --gpus all         \
  --restart always     \
  -p 8000:8080         \
  --name "mmcf"          \
  --shm-size 2G      \
  -v ./home/junha/docker/mmclf/mmclassification   \ # 가능하면 무조건 절대경로 사용할 것
  -v /hdd1T:/dataset   \
  pytorch/pytorch:1.5.1-cuda10.1-cudnn7-devel
  
  $ sudo docker run -d -it      \
  --gpus all         \
  --restart always     \
  -p 8080:8080         \
  --name "mmcl"          \
  --shm-size 2G      \
  -v /home/junha/docker:/workspace  \
  -v /hdd1T:/dataset   \
  sb020518/mmcl:0.1
  ```



# 3. mm installation

- **mmcv installation**    

  ```sh
  $ apt-get update
  $ apt-get install ffmpeg libsm6 libxext6  -y
  $ pip install mmcv-full==1.3.0 -f https://download.openmmlab.com/mmcv/dist/cu101/torch1.5.0/index.html
  ```

- [mmclasification install](https://github.com/open-mmlab/mmclassification)    

  ```sh
  $ git clone https://github.com/open-mmlab/mmclassification.git
  $ cd mmclassification
  $ pip install -e .  # or "python setup.py develop"
  ```

- **mmclasification install Test**    

  ```sh
  python demo/image_demo.py \
  /workspace/checkpoints/dog.jpg  \
  /workspace/configs/resnet/resnet50_b32x8_imagenet.py  \
  /workspace/checkpoints/resnet50_batch256_imagenet_20200708-cfb998bf.pth 
  ```



# 4. 코드 공부 흐름

1. Interence 흐름 따라가기 
2. Tranin 흐름 따라가기
3. Dataloader 공부하기
4. Loss, Optimizer, Scheduler 분석하기
5. Model save load, check point 분석하기
6. Batch 구성방법, GPU 분산학습 분석하기



# 5. mmclassification/getting_started.md

- **Prepare datasets**
  - ImageNet 다운로드. 각 클래스는 같은 폴더에 넣어주기 위한 sh 실행 ([참조사이트](https://seongkyun.github.io/others/2019/03/06/imagenet_dn/)). 
  - MNIST, CIFAR10 and CIFAR100와 같은 데이터 셋은, 만약 데이터셋이 없다면 자동으로 다운 받아진다. 
- Inference a dataset
  - Inference는 이미지를 모델이 넣고 나오는 결과를 직접 눈으로 확인해보는게 목적이다.  
  - mmclassification에서는 inference.py 파일이 아에 없다. 
  - 굳이 하고 싶다면, demo/image_demo.py를 이용하자. 
- Test a datatset
  - Test는 mAP를 직접 계산해보는게 목적이다. 
  - `tools/test.py`, `tools/dist_test.sh` 
  - `dist_test.sh`는 결국 `tools/test.py` 실행한다. 
  - `$ python tools/test.py ${CONFIG_FILE} ${CHECKPOINT_FILE} [--out ${RESULT_FILE}] ` 이거로 먼저 debuging하고 그 다음에 dist_test.sh 파일을 이용해서 multi-gpu testing을 진행하자.
  - `$ python tools/test.py  configs/resnet/resnet50_b32x8_imagenet.py checkpoints/resnet50_batch256_imagenet_20200708-cfb998bf.pth` 
  - Ouput 결과를 출력해서 보는 것은 좀더 차차 공부해보자. 
- Train a dataset 



https://github.com/open-mmlab/mmclassification/blob/master/docs/getting_started.md

https://github.com/open-mmlab/mmclassification





